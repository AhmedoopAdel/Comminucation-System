@model WebApplication10.Models.Post
@{
    ViewData["Title"] = $"منشور لـ {Model.User.Username}";
    var currentUserId = Context.Session.GetInt32("UserId");
    var isLiked = Model.Likes.Any(l => l.UserId == currentUserId);
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">

            <div class="card post-card shadow-sm mb-4" id="post-@Model.Id">
                <div class="card-header d-flex align-items-center bg-white border-bottom-0">
                    <a href="/account/Profile/@Model.User.Id" class="d-flex align-items-center text-decoration-none text-dark">
                        <img src="https://via.placeholder.com/40" class="rounded-circle me-3" style="width: 40px; height: 40px;" alt="صورة المستخدم">
                        <div>
                            <h5 class="mb-0 fw-bold">@Model.User.Username</h5>
                            <small class="text-muted">@Model.CreatedAt.ToString("g")</small>
                        </div>
                    </a>
                </div>

                <div class="card-body pt-0">
                    <p class="card-text fs-5">@Html.Raw(Model.Content)</p>

                    @if (!string.IsNullOrEmpty(Model.ImageUrl))
                    {
                        <img src="@Model.ImageUrl" alt="Post Image" class="img-fluid rounded mb-3" />
                    }
                </div>

                <div class="card-footer bg-white border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-primary fw-bold">
                            <i class="bi bi-heart-fill"></i> <span id="like-count">@Model.Likes.Count</span> إعجاب
                        </small>
                        <small class="text-secondary">
                            <i class="bi bi-chat-left-text-fill"></i> <span id="comment-count">@Model.Comments.Count</span> تعليق
                        </small>
                    </div>

                    <div class="d-flex justify-content-around border-top pt-2">

                        <button type="button"
                                class="btn btn-sm btn-light text-primary like-btn @(isLiked ? "active-like" : "")"
                                data-post-id="@Model.Id"
                                onclick="toggleLike(this)">
                            <i class="bi bi-hand-thumbs-up-fill"></i>
                            <span class="like-text">@(isLiked ? "أعجبني" : "إعجاب")</span>
                        </button>

                        <button class="btn btn-sm btn-light text-success">
                            <i class="bi bi-share-fill"></i> مشاركة
                        </button>
                    </div>
                </div>
            </div>

            <h4 class="mb-3 mt-5 text-secondary">التعليقات (<span id="comment-count-header">@Model.Comments.Count</span>)</h4>

            <div class="card p-3 mb-4 shadow-sm">
                <h6 class="mb-3">أضف تعليقًا:</h6>
                <form class="comment-form-main d-flex flex-column" data-post-id="@Model.Id" onsubmit="handleCommentSubmit(event, this)">
                    <input type="hidden" name="postId" value="@Model.Id" />
                    <textarea name="content" class="form-control mb-2 comment-content" rows="2" placeholder="اكتب تعليقك هنا..." required></textarea>
                    <button type="submit" class="btn btn-primary align-self-end comment-submit-btn">إرسال التعليق</button>
                </form>
            </div>

            <div id="comments-container">
                @foreach (var c in Model.Comments.Where(x => x.ParentCommentId == null).OrderByDescending(x => x.CreatedAt))
                {
                    <div class="card comment-card mb-3 p-3 border-0 shadow-sm" id="comment-@c.Id">
                        <div class="d-flex align-items-start">
                            <img src="https://via.placeholder.com/30" class="rounded-circle me-3" style="width: 30px; height: 30px;" alt="صورة المعلق">
                            <div>
                                <small class="fw-bold me-2">@c.User.Username:</small>
                                <span class="text-wrap">@c.Content</span>
                                <p class="text-muted small mt-1 mb-2">@c.CreatedAt.ToString("g")</p>

                                <button class="btn btn-sm btn-link text-secondary p-0 mb-2"
                                        data-bs-toggle="collapse" data-bs-target="#replyForm-@c.Id">
                                    <i class="bi bi-reply-fill"></i> رد
                                </button>

                                <div class="collapse mt-2" id="replyForm-@c.Id">
                                    <form class="comment-reply-form d-flex"
                                          data-post-id="@Model.Id"
                                          data-parent-id="@c.Id"
                                          onsubmit="handleCommentSubmit(event, this)">
                                        <input type="hidden" name="postId" value="@Model.Id" />
                                        <input type="hidden" name="parentCommentId" value="@c.Id" />
                                        <input type="text" name="content" class="form-control form-control-sm me-2 comment-content" placeholder="اكتب الرد..." required />
                                        <button type="submit" class="btn btn-sm btn-success comment-submit-btn">إرسال</button>
                                    </form>
                                </div>

                                <div class="replies-container-@c.Id">
                                    @if (c.Replies != null && c.Replies.Any())
                                    {
                                        <div class="mt-3 ps-3 border-start border-2 border-info">
                                            @foreach (var reply in c.Replies.OrderBy(x => x.CreatedAt))
                                            {
                                                <div class="d-flex align-items-start mb-2">
                                                    <img src="https://via.placeholder.com/25" class="rounded-circle me-2" style="width: 25px; height: 25px;" alt="صورة الرد">
                                                    <div>
                                                        <small class="fw-bold me-2">@reply.User.Username:</small>
                                                        <span class="text-wrap">@reply.Content</span>
                                                        <p class="text-muted small mt-1 mb-0">@reply.CreatedAt.ToString("g")</p>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <style>
        .active-like {
            color: white !important;
            background-color: #0d6efd !important;
        }
    </style>
    <script>
        // دالة مساعدة لإنشاء HTML للتعليق الجديد/الرد الجديد
        function createCommentHtml(data, isReply = false) {
            const imageSize = isReply ? 25 : 30;
            const userClass = isReply ? 'small fw-bold' : 'fw-bold me-2';
            const html = `
                <div class="d-flex align-items-start mb-2 ${isReply ? '' : 'card comment-card p-3 border-0 shadow-sm'}">
                    <img src="https://via.placeholder.com/${imageSize}" class="rounded-circle me-3" style="width: ${imageSize}px; height: ${imageSize}px;" alt="صورة المعلق">
                    <div>
                        <small class="${userClass}">${data.username}:</small>
                        <span class="text-wrap">${data.content}</span>
                        <p class="text-muted small mt-1 mb-2">${new Date().toLocaleTimeString()}</p>
                        ${!isReply ? `
                            <button class="btn btn-sm btn-link text-secondary p-0 mb-2"
                                    data-bs-toggle="collapse" data-bs-target="#replyForm-${data.commentId}">
                                <i class="bi bi-reply-fill"></i> رد
                            </button>
                            <div class="collapse mt-2" id="replyForm-${data.commentId}">
                                <form class="comment-reply-form d-flex" data-post-id="${data.postId}" data-parent-id="${data.commentId}" onsubmit="handleCommentSubmit(event, this)">
                                    <input type="hidden" name="postId" value="${data.postId}" />
                                    <input type="hidden" name="parentCommentId" value="${data.commentId}" />
                                    <input type="text" name="content" class="form-control form-control-sm me-2 comment-content" placeholder="اكتب الرد..." required />
                                    <button type="submit" class="btn btn-sm btn-success comment-submit-btn">إرسال</button>
                                </form>
                            </div>
                            <div class="replies-container-${data.commentId}"></div>
                        ` : ''}
                    </div>
                </div>`;
            return html;
        }

        // =======================================================
        // 1. دالة الإعجاب (ToggleLike) - AJAX
        // =======================================================
        async function toggleLike(button) {
            const postId = button.getAttribute('data-post-id');
            const isCurrentlyLiked = button.classList.contains('active-like');

            // تحديث الـ UI فورا
            button.classList.toggle('active-like');
            const likeCountElement = document.getElementById('like-count');
            let currentCount = parseInt(likeCountElement.textContent);

            if (isCurrentlyLiked) {
                likeCountElement.textContent = currentCount - 1;
                button.querySelector('.like-text').textContent = "إعجاب";
            } else {
                likeCountElement.textContent = currentCount + 1;
                button.querySelector('.like-text').textContent = "أعجبني";
            }

            try {
                const response = await fetch('/Post/ToggleLike', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `postId=${postId}`
                });

                const data = await response.json();

                if (data.success) {
                    likeCountElement.textContent = data.newLikeCount;
                    // تأكيد حالة الزر
                    if (data.isLiked) {
                        button.classList.add('active-like');
                        button.querySelector('.like-text').textContent = "أعجبني";
                    } else {
                        button.classList.remove('active-like');
                        button.querySelector('.like-text').textContent = "إعجاب";
                    }
                } else {
                    alert('فشل الإعجاب. يرجى تسجيل الدخول.');
                    // إذا فشل الطلب، إرجاع الـ UI
                    button.classList.toggle('active-like');
                    likeCountElement.textContent = currentCount;
                }

            } catch (error) {
                console.error('Error toggling like:', error);
                alert('حدث خطأ في الاتصال.');
                // إرجاع الـ UI
                button.classList.toggle('active-like');
                likeCountElement.textContent = currentCount;
            }
        }


        // =======================================================
        // 2. دالة إضافة التعليق أو الرد (AddComment) - AJAX
        // =======================================================
        async function handleCommentSubmit(event, form) {
            event.preventDefault(); // منع تحديث الصفحة

            const postId = form.getAttribute('data-post-id');
            const parentCommentId = form.getAttribute('data-parent-id');
            const contentInput = form.querySelector('.comment-content');
            const content = contentInput.value;

            if (!content) return;

            const submitButton = form.querySelector('.comment-submit-btn');
            submitButton.disabled = true;

            // بناء الـ body
            let bodyData = `postId=${postId}&content=${encodeURIComponent(content)}`;
            if (parentCommentId) {
                bodyData += `&parentCommentId=${parentCommentId}`;
            }

            try {
                const response = await fetch('/Post/AddComment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: bodyData
                });

                const data = await response.json();
                submitButton.disabled = false;
                contentInput.value = ''; // تنظيف الحقل

                if (data.success) {
                    const isReply = parentCommentId != null && parentCommentId !== undefined;
                    const newCommentHtml = createCommentHtml(data, isReply);

                    // تحديث عدادات التعليقات
                    document.getElementById('comment-count').textContent = data.newCommentCount;
                    document.getElementById('comment-count-header').textContent = data.newCommentCount;

                    if (isReply) {
                        // إضافة الرد في الـ replies-container المناسب
                        const repliesContainer = document.querySelector(`.replies-container-${parentCommentId}`);
                        if (repliesContainer) {
                            // إذا كانت الحاوية لا تحتوي على محتوى الردود، أضف الـ border
                            if (!repliesContainer.querySelector('.border-start')) {
                                repliesContainer.innerHTML = `<div class="mt-3 ps-3 border-start border-2 border-info"></div>`;
                            }
                            repliesContainer.querySelector('.border-start').insertAdjacentHTML('beforeend', newCommentHtml);
                        }
                        // إغلاق نموذج الرد
                        const collapseElement = document.getElementById(`replyForm-${parentCommentId}`);
                        if (collapseElement) {
                             new bootstrap.Collapse(collapseElement, { toggle: false }).hide();
                        }
                    } else {
                        // إضافة تعليق رئيسي جديد في البداية
                        document.getElementById('comments-container').insertAdjacentHTML('afterbegin', newCommentHtml);
                    }
                } else {
                    alert('فشل إضافة التعليق: ' + (data.message || 'خطأ غير معروف'));
                }

            } catch (error) {
                console.error('Error adding comment:', error);
                submitButton.disabled = false;
                alert('حدث خطأ في الاتصال.');
            }
        }
    </script>
}